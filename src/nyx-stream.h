/* NyxStream
 * Author: Jérôme ODIER <jerome.odier@lpsc.in2p3.fr>
 * SPDX-License-Identifier: GPL-2.0-only
 */

/*--------------------------------------------------------------------------------------------------------------------*/

#ifndef NYX_STREAM_H
#define NYX_STREAM_H

/*--------------------------------------------------------------------------------------------------------------------*/

#include <stddef.h>
#include <stdint.h>
#include <stdbool.h>

/*--------------------------------------------------------------------------------------------------------------------*/

#define __NYX_NOTNULL__ \
            /* do nothing */

#define __NYX_NULLABLE__ \
            /* do nothing */

#define __NYX_ZEROABLE__ \
            /* do nothing */

#define __NYX_UNUSED__ \
            __attribute__ ((unused))

#define __NYX_INLINE__ \
            __attribute__ ((always_inline)) static inline

/*--------------------------------------------------------------------------------------------------------------------*/

#define str_t /*-*/ char *
#define STR_t const char *

#define buff_t /*-*/ void *
#define BUFF_t const void *

/*--------------------------------------------------------------------------------------------------------------------*/

#define buffof(p) \
            ((buff_t *) (p))

/*--------------------------------------------------------------------------------------------------------------------*/

__NYX_INLINE__ uint32_t nyx_read_u32_le(const uint8_t *buff)
{
    return ((uint32_t) buff[0] << 0)
           |
           ((uint32_t) buff[1] << 8)
           |
           ((uint32_t) buff[2] << 16)
           |
           ((uint32_t) buff[3] << 24)
    ;
}

/*--------------------------------------------------------------------------------------------------------------------*/
/* MEM                                                                                                                */
/*--------------------------------------------------------------------------------------------------------------------*/

size_t nyx_memory_free(__NYX_NULLABLE__ buff_t buff);

buff_t nyx_memory_alloc(__NYX_ZEROABLE__ size_t size);

buff_t nyx_memory_realloc(__NYX_NULLABLE__ buff_t buff, __NYX_ZEROABLE__ size_t size);

/*--------------------------------------------------------------------------------------------------------------------*/
/* HASH                                                                                                               */
/*--------------------------------------------------------------------------------------------------------------------*/

uint32_t nyx_hash(__NYX_ZEROABLE__ size_t size, __NYX_NULLABLE__ BUFF_t buff, uint32_t seed);

/*--------------------------------------------------------------------------------------------------------------------*/
/* CONFIG                                                                                                             */
/*--------------------------------------------------------------------------------------------------------------------*/

#define NYX_CONFIG_PATH "/etc/nyx-stream/config.json"

/*--------------------------------------------------------------------------------------------------------------------*/

bool nyx_load_config(
    str_t *tcp_url,
    str_t *http_url,
    str_t *mqtt_url,
    str_t *mqtt_username,
    str_t *mqtt_password,
    str_t *poll_ms
);

/*--------------------------------------------------------------------------------------------------------------------*/

#endif /* NYX_STREAM_H */

/*--------------------------------------------------------------------------------------------------------------------*/
