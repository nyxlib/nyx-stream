/* NyxStream
 * Author: Jérôme ODIER <jerome.odier@lpsc.in2p3.fr>
 * SPDX-License-Identifier: GPL-2.0-only
 */

/*--------------------------------------------------------------------------------------------------------------------*/

#include "nyx-stream.h"

#include "external/mongoose.h"

/*--------------------------------------------------------------------------------------------------------------------*/

#define CONFIG_PATH "/etc/nyx-stream/config.json"

/*--------------------------------------------------------------------------------------------------------------------*/

static bool _read_file(const char *path, size_t *size_out, buff_t *buff_out)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    FILE *fp = fopen(path, "rb");

    if(fp == NULL)
    {
        *size_out = 0x00;
        *buff_out = NULL;

        return false;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    fseek(fp, 0x000000, SEEK_END);

    const size_t fs = (size_t) ftell(fp);

    rewind(fp);

    /*----------------------------------------------------------------------------------------------------------------*/

    *size_out = fread(*buff_out = nyx_memory_alloc(fs), 1, fs, fp);

    /*----------------------------------------------------------------------------------------------------------------*/

    fclose(fp);

    /*----------------------------------------------------------------------------------------------------------------*/

    return true;
}

/*--------------------------------------------------------------------------------------------------------------------*/

bool nyx_load_config(
    str_t *tcp_url,
    str_t *http_url,
    str_t *mqtt_url,
    str_t *mqtt_username,
    str_t *mqtt_password,
    str_t *poll_ms
) {
    /*----------------------------------------------------------------------------------------------------------------*/

    size_t size;
    buff_t buff;

    if(_read_file(CONFIG_PATH, &size, &buff) == false)
    {
        MG_ERROR(("Cannot read file `%s`", CONFIG_PATH));

        return false;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    const struct mg_str json = mg_str_n(buff, size);

    /*----------------------------------------------------------------------------------------------------------------*/

    *tcp_url = mg_json_get_str(json, "$.tcp_url");
    *http_url = mg_json_get_str(json, "$.http_url");
    *mqtt_url = mg_json_get_str(json, "$.mqtt_url");
    *mqtt_username = mg_json_get_str(json, "$.username");
    *mqtt_password = mg_json_get_str(json, "$.password");
    *poll_ms = mg_json_get_str(json, "$.poll_ms");

    /*----------------------------------------------------------------------------------------------------------------*/

    nyx_memory_free(buff);

    /*----------------------------------------------------------------------------------------------------------------*/

    return true;
}

/*--------------------------------------------------------------------------------------------------------------------*/
