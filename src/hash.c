/* NyxStream
 * Author: Jérôme ODIER <jerome.odier@lpsc.in2p3.fr>
 * SPDX-License-Identifier: GPL-2.0-only
 */

/*--------------------------------------------------------------------------------------------------------------------*/

#include <string.h>

#include "nyx-stream.h"

/*--------------------------------------------------------------------------------------------------------------------*/

static const uint32_t MURMUR2_MAGIC = 0x5BD1E995UL;

/*--------------------------------------------------------------------------------------------------------------------*/

uint32_t nyx_hash32(size_t size, BUFF_t buff, uint32_t seed)
{
    if(size == 0x00
       ||
       buff == NULL
    ) {
        return seed;
    }

    uint32_t h = seed ^ (uint32_t) size;

    /*----------------------------------------------------------------------------------------------------------------*/

    const uint8_t *data = buff;

    for(uint32_t k; size >= 4;)
    {
        memcpy(&k, data, sizeof(k));

        k *= MURMUR2_MAGIC;
        k ^= k >> 24;
        k *= MURMUR2_MAGIC;

        h *= MURMUR2_MAGIC;
        h ^= k >> 0;

        data += 4;
        size -= 4;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    switch(size)
    {
        case 3: h ^= ((uint32_t) data[2]) << 16;    /* fallthrough */
        case 2: h ^= ((uint32_t) data[1]) << 8;     /* fallthrough */
        case 1: h ^= ((uint32_t) data[0]) << 0;     /* fallthrough */
                h *= MURMUR2_MAGIC;
        default:
            break;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    h ^= h >> 13;
    h *= MURMUR2_MAGIC;
    h ^= h >> 15;

    /*----------------------------------------------------------------------------------------------------------------*/

    return h;
}

/*--------------------------------------------------------------------------------------------------------------------*/
